TaskCluster - API Design
========================

This repository outlines the formal API design for the TaskCluster.


Things To Do
============

  * Define REST Queue API
  * RabbitMQ Exchanges
  * S3 Layout


Random Useful Notes
===================

Upload to signed URL with `curl -T <file-to-upload> -X PUT "<signed-url>"`

Design Goals
------------
  * AMQP is only for message exchange, not keep alive, state or data, we should
    only use it for events that have relevance now.
  * State of tasks should be eventually consistent on S3
  * Database should hold state while task is executed
  * Keep it simple

Terminology
-----------
  * Task, a unit of work executed by the task cluster
  * Artifact, a result generated by a worker
  * Queue, place that hold state of pending and running tasks and ensures they
    are eventually scheduled.
  * Resolution, a task is resolved once, the 2 resolved states are 'completed'
    and 'failed', if a task gets canceled it fails.
  * `worker-type` is string that identifies a kind of worker, this should
    basically be virtual image version.


Common Data Types
-----------------

    task-id           uuid v4           Unique task identifier
    worker-type       [^.]*             String identifying a worker type/class
                      (max 64 chars, not containing any dots)
    state             enum              pending|running|completed|failed
    run-id            int               Int that for each task-id starts from 1
    worker-id         [^.]*\.[^.]*      Unique Worker identifier
                      (max 64 chars, must contain exactly one dot)

    task-status       JSON              Task status structure
    {
      task_id, worker_type, state, reason, retries, deadline, priority,
      taken_until, runs : [{run_id, worker_id}]
    }


Queue Database Schema
---------------------

**Tasks Table** (also known as task status structure)

    task_id           uuid
    worker_type       string max 64
    state             pending|running|completed|failed|canceled
    reason            none|retries-failed|timeout|...
    retries           Int (number of retries left)
    deadline          timestamp
    priority          double
    taken_until       timestamp (usual set to now + 20 min whenever the task
                      is assigned, claimed or reclaimed)

**Runs Table**

    run_id            int
    task_id           uuid
    worker_id         worker-id (use if we have to cancel the task)
    primary key(run_id, task_id)